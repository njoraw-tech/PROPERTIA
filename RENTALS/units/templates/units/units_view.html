{% extends 'templates/dashboard_base.html' %}
{% load static %}


{% block extra_js %}
    <script src="{% static 'js/units.js' %}"></script>
{% endblock extra_js %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Units</h2>
        <div class="d-flex gap-2">
            <button type="button" id="deleteSelectedBtn" class="btn btn-danger" style="display: none;">
                <i class="fas fa-trash me-1"></i> DELETE SELECTED
            </button>
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#uploadUnitsModal"><i class="bi bi-upload"></i> UPLOAD UNITS</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUnitModal">+ ADD UNIT</button>
        </div>
    </div>

    <div class="card shadow-sm mb-3 border-0">
        <div class="card-body py-2">
            <form method="GET" class="row g-2 justify-content-end">
                <div class="col-md-3">
                    <select name="property" class="form-select border-0 bg-light">
                        <option value="">All Properties</option>
                        {% for p in properties %}
                        <option value="{{ p.id }}" {% if request.GET.property == p.id|stringformat:"i" %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="status" class="form-select border-0 bg-light">
                        <option value="">All Status</option>
                        <option value="occupied">Occupied</option>
                        <option value="vacant">Vacant</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark w-100">FILTER</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4"><input type="checkbox" id="selectAllCheckbox" class="form-check-input"></th>
                        <th>Unit</th>
                        <th>Property</th>
                        <th>Rent</th>
                        <th>Status</th>
                        <th>Tenant</th>
                        <th class="text-end pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for unit in units %}
                    <tr class="align-middle">
                        <td class="ps-4"><input type="checkbox" class="form-check-input unit-checkbox" value="{{ unit.id }}"></td>
                        <td class="fw-bold">{{ unit.name }}</td>
                        <td>{{ unit.property.name }}</td>
                        <td>{{ unit.rent_amount }}</td>
                        <td>
                            {% if unit.get_assigned_tenant %}
                                <span class="badge bg-success text-white">occupied</span>
                            {% else %}
                                <span class="badge bg-warning-subtle text-warning">vacant</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if unit.get_assigned_tenant %}
                                {{ unit.get_tenant_display_name }}
                            {% else %}
                                <span class="text-muted">---</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-4">
                            {% if unit.status == 'occupied' %}
                                <button class="btn btn-sm btn-light border detachTenantBtn" data-unit-id="{{ unit.id }}" data-unit-name="{{ unit.name }}"><i class="bi bi-person"></i> Detach</button>
                            {% else %}
                                <button class="btn btn-sm btn-light border assignTenantBtn" data-unit-id="{{ unit.id }}" data-unit-name="{{ unit.name }}" data-bs-toggle="modal" data-bs-target="#assignTenantModal"><i class="bi bi-person-plus"></i> Assign</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="text-center py-4">No units found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addUnitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Add New Unit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUnitForm" method="post">
                {% csrf_token %}
                <div id="unitErrors" class="alert alert-danger mx-4 mt-3" style="display: none;"></div>
                <div class="modal-body px-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Property Name</label>
                        {{ form.property }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Unit Name</label>
                        {{ form.name }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Rent Amount</label>
                        {{ form.rent_amount }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Description</label>
                        {{ form.description }}
                    </div>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="submit" class="btn btn-primary px-4">Add Unit</button>
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Clear</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadUnitsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Upload Units</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadUnitsForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body px-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">CSV or XLSX File</label>
                        <input type="file" id="unitsFile" name="file" class="form-control" accept=".csv,.xlsx" required>
                        <small class="text-muted d-block mt-2"><strong>Required Headers:</strong> property, name, rent_amount<br><strong>Optional Headers:</strong> description, status</small>
                    </div>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="assignTenantModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Assign Tenant to Unit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignTenantForm">
                {% csrf_token %}
                <input type="hidden" id="assignUnitId" name="unit_id" value="">
                <div class="modal-body px-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Unit</label>
                        <p id="assignUnitName" class="m-0 fw-bold text-primary"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Tenant</label>
                        <select id="assignTenantSelect" name="tenant_id" class="form-select" required>
                            <option value="">-- Select a Tenant --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Tenant</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const unitCheckboxes = document.querySelectorAll('.unit-checkbox');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const assignButtons = document.querySelectorAll('.assignTenantBtn');
    const detachButtons = document.querySelectorAll('.detachTenantBtn');
    const assignTenantForm = document.getElementById('assignTenantForm');
    const addUnitForm = document.getElementById('addUnitForm');
    
    // ======================
    // ADD UNIT FUNCTIONALITY
    // ======================
    if (addUnitForm) {
        addUnitForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                // Check if response contains form errors
                if (html.includes('errorlist') || html.includes('This field is required')) {
                    // Display errors in modal
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const errorElements = doc.querySelectorAll('ul.errorlist');
                    
                    let errorHtml = '<ul>';
                    errorElements.forEach(el => {
                        const items = el.querySelectorAll('li');
                        items.forEach(item => {
                            errorHtml += '<li>' + item.textContent + '</li>';
                        });
                    });
                    errorHtml += '</ul>';
                    
                    if (errorElements.length > 0) {
                        document.getElementById('unitErrors').innerHTML = errorHtml;
                        document.getElementById('unitErrors').style.display = 'block';
                    } else {
                        location.reload();
                    }
                } else {
                    // Success - reload page
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred');
            });
        });
    }
    
    // ======================
    // ASSIGN TENANT FUNCTIONALITY
    // ======================
    assignButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const unitId = this.getAttribute('data-unit-id');
            const unitName = this.getAttribute('data-unit-name');
            
            // Set unit info in modal
            document.getElementById('assignUnitId').value = unitId;
            document.getElementById('assignUnitName').textContent = unitName;
            
            // Fetch available tenants
            fetch(`/units/assign/${unitId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tenantSelect = document.getElementById('assignTenantSelect');
                tenantSelect.innerHTML = '<option value="">-- Select a Tenant --</option>';
                
                if (data.tenants && data.tenants.length > 0) {
                    data.tenants.forEach(tenant => {
                        const option = document.createElement('option');
                        option.value = tenant.id;
                        option.textContent = `${tenant.first_name} ${tenant.last_name}`;
                        tenantSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.textContent = 'No available tenants';
                    option.disabled = true;
                    tenantSelect.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load tenants');
            });
        });
    });
    
    // Handle assign form submission
    if (assignTenantForm) {
        assignTenantForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const unitId = document.getElementById('assignUnitId').value;
            const tenantId = document.getElementById('assignTenantSelect').value;
            
            if (!tenantId) {
                alert('Please select a tenant');
                return;
            }
            
            const formData = new FormData();
            formData.append('tenant_id', tenantId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch(`/units/assign/${unitId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message || 'Failed to assign tenant');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while assigning the tenant');
            });
        });
    }
    
    // ======================
    // DETACH TENANT FUNCTIONALITY
    // ======================
    detachButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const unitId = this.getAttribute('data-unit-id');
            const unitName = this.getAttribute('data-unit-name');
            
            if (confirm(`Are you sure you want to detach the tenant from ${unitName}?`)) {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                fetch(`/units/detach/${unitId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message || 'Failed to detach tenant');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while detaching the tenant');
                });
            }
        });
    });
    
    // ======================
    // UPLOAD UNITS FUNCTIONALITY
    // ======================
    const uploadForm = document.getElementById('uploadUnitsForm');
    
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('unitsFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            // Validate file type
            const validTypes = ['text/csv', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            if (!validTypes.includes(file.type) && !file.name.endsWith('.csv') && !file.name.endsWith('.xlsx')) {
                alert('Please upload a CSV or XLSX file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('/units/upload/', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully uploaded ${data.count} units`);
                    location.reload();
                } else {
                    alert(data.message || 'Failed to upload units');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while uploading units');
            });
        });
    }
    
    // ======================
    // DELETE UNITS FUNCTIONALITY
    // ======================
    
    // Select/Deselect all
    selectAllCheckbox.addEventListener('change', function() {
        unitCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateDeleteButton();
    });
    
    // Update delete button visibility
    unitCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateDeleteButton);
    });
    
    function updateDeleteButton() {
        const anySelected = Array.from(unitCheckboxes).some(cb => cb.checked);
        deleteSelectedBtn.style.display = anySelected ? 'inline-block' : 'none';
    }
    
    // Delete selected units
    deleteSelectedBtn.addEventListener('click', function() {
        const selectedIds = Array.from(unitCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            alert('Please select at least one unit to delete');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${selectedIds.length} unit/s? This action cannot be undone.`)) {
            const formData = new FormData();
            selectedIds.forEach(id => formData.append('unit_ids[]', id));
            
            fetch('{% url "units:delete_units" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || ''
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message || 'Failed to delete units');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting units');
            });
        }
    });
});
</script>

{% endblock %}